<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSE Fix Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .log { background-color: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>SSE Fix Test</h1>
    <div id="status" class="status disconnected">Connecting...</div>
    <div id="log" class="log"></div>

    <!-- Load the fixed JavaScript files -->
    <script src="js/services/sse-service.js"></script>
    <script src="js/services/incident-realtime-service.js"></script>
    <script src="js/services/incident-data-service.js"></script>
    <script src="js/app-railway.js"></script>

    <script>
        // Test the SSE connection
        const log = document.getElementById('log');
        const status = document.getElementById('status');
        
        function addLog(message) {
            log.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            log.scrollTop = log.scrollHeight;
        }

        // Override console.log to show in the page
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog(args.join(' '));
        };

        // Override console.error to show in the page
        const originalError = console.error;
        console.error = function(...args) {
            originalError.apply(console, args);
            addLog('ERROR: ' + args.join(' '));
        };

        addLog('Starting SSE test...');
        addLog('Current URL: ' + window.location.href);
        addLog('Protocol: ' + window.location.protocol);
        addLog('Host: ' + window.location.host);
        
        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', () => {
            addLog('DOM ready, starting tests...');
            
            // Test 1: Check if SSEService is available
            if (typeof SSEService === 'undefined') {
                addLog('ERROR: SSEService not found!');
                return;
            }
            addLog('✅ SSEService found');
            
            // Test 2: Create SSE service and check URL
            const sseService = new SSEService();
            const sseUrl = sseService.getSSEUrl();
            addLog('SSE URL: ' + sseUrl);
            
            // Test 3: Set up event handlers
            sseService.onInitialData((data) => {
                addLog('✅ Received initial data: ' + JSON.stringify(data).substring(0, 100) + '...');
                status.textContent = 'Connected - Initial data received!';
                status.className = 'status connected';
            });
            
            sseService.onConnectionChange((status) => {
                addLog('Connection status: ' + (status.connected ? 'Connected' : 'Disconnected'));
                if (status.connected) {
                    status.textContent = 'Connected!';
                    status.className = 'status connected';
                } else {
                    status.textContent = 'Disconnected';
                    status.className = 'status disconnected';
                }
            });
            
            sseService.onError((error) => {
                addLog('SSE Error: ' + JSON.stringify(error));
                status.textContent = 'Error: ' + (error.error || 'Unknown error');
                status.className = 'status disconnected';
            });
            
            sseService.onIncidentUpdate((data) => {
                addLog('Incident update: ' + data.center + ' - ' + data.incidentCount + ' incidents');
            });
            
            // Test 4: Connect to Railway SSE
            addLog('Attempting to connect to SSE...');
            sseService.connect().then(() => {
                addLog('SSE connection initiated');
            }).catch(error => {
                addLog('Failed to connect: ' + error.message);
                status.textContent = 'Connection failed: ' + error.message;
                status.className = 'status disconnected';
            });
        });
    </script>
</body>
</html>
